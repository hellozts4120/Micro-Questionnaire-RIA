"use strict";function calendar(selector,upperYear,lowerYear,type){function curTime(){var now=new Date,date=(now.getSeconds(),now.getMinutes(),now.getHours,now.getDate()),day=now.getDay(),month=now.getMonth(),year=now.getFullYear();return[year,month+1,date,day]}function addCommonDateInfo(year,month){$(".select-date table tbody tr").remove();for(var sumCurMonthDate=getMonthDate(year,month),sumPrevMonthDate=getMonthDate(year,month-1),curMonthFirstDay=new Date(year+"/"+month+"/1").getDay(),curMonthLastDay=new Date(year+"/"+month+"/"+sumCurMonthDate).getDay(),curTr=document.createElement("tr"),i=sumPrevMonthDate-curMonthFirstDay+1;sumPrevMonthDate>=i;i++){var curTd=document.createElement("td");curTd.innerHTML=i,curTd.className="prevMonth",curTr.appendChild(curTd)}for(var i=1;sumCurMonthDate>=i;i++){var curTd=document.createElement("td");curTd.innerHTML=i,curTd.className="currMonth",i==curTime()[2]&&month==curTime()[1]&&year==curTime()[0]&&0==type&&(curTd.className="currMonth currDate"),curTr.appendChild(curTd)}if(6!==curMonthLastDay)for(var start=1;6-curMonthLastDay>=start;start++){var curTd=document.createElement("td");curTd.innerHTML=start,curTd.className="nextMonth",curTr.appendChild(curTd)}$(".select-date table tbody").append(curTr),$(".currMonth").on("click",function(e){var currYear=document.getElementById("year").selectedOptions[0].value,currMonth=document.getElementById("month").selectedOptions[0].value,currDate=e.target.innerHTML;document.getElementById("date-input").value=parseInt(currYear)+"-"+(parseInt(currMonth)<10?"0":"")+parseInt(currMonth)+"-"+(parseInt(currDate)<10?"0":"")+parseInt(currDate),$(".calendarTitle,.select-date").remove(),that.isShow=0})}function addPeriodDateInfo(year,month){$(".select-date table tbody tr").remove();for(var sumCurMonthDate=getMonthDate(year,month),sumPrevMonthDate=getMonthDate(year,month-1),curMonthFirstDay=new Date(year+"/"+month+"/1").getDay(),curMonthLastDay=new Date(year+"/"+month+"/"+sumCurMonthDate).getDay(),curTr=document.createElement("tr"),i=sumPrevMonthDate-curMonthFirstDay+1;sumPrevMonthDate>=i;i++){var curTd=document.createElement("td");curTd.innerHTML=i,curTd.className="prevMonth",curTr.appendChild(curTd)}for(var i=1;sumCurMonthDate>=i;i++){var curTd=document.createElement("td");curTd.innerHTML=i,that.startDate&&that.endDate?year==that.startDate[0]&&month==that.startDate[1]&&i==that.startDate[2]||year==that.endDate[0]&&month==that.endDate[1]&&i==that.endDate[2]?curTd.className="currMonth currDate":year>=that.startDate[0]&&year<=that.endDate[0]&&month>=that.startDate[1]&&month<=that.endDate[1]&&i>that.startDate[2]&&i<that.endDate[2]?curTd.className="currMonth periodDate":year<=that.startDate[0]&&year>=that.endDate[0]&&month<=that.startDate[1]&&month>=that.endDate[1]&&i<that.startDate[2]&&i>that.endDate[2]?curTd.className="currMonth periodDate":year>=that.startDate[0]&&year<=that.endDate[0]&&month>that.startDate[1]&&month<=that.endDate[1]&&i<that.endDate[2]||month<that.endDate[1]&&month>=that.startDate[1]&&i>that.startDate[2]?curTd.className="currMonth periodDate":year<=that.startDate[0]&&year>=that.endDate[0]&&month<that.startDate[1]&&month>=that.endDate[1]&&i>that.endDate[2]||month>that.endDate[1]&&month<=that.startDate[1]&&i<that.startDate[2]?curTd.className="currMonth periodDate":year>that.startDate[0]&&year<=that.endDate[0]||year<=that.startDate[0]&&year>that.endDate[0]?curTd.className="currMonth periodDate":year<that.startDate[0]&&year>=that.endDate[0]||year>=that.startDate[0]&&year<that.endDate[0]?curTd.className="currMonth periodDate":curTd.className="currMonth":that.startDate&&year==that.startDate[0]&&month==that.startDate[1]&&i==that.startDate[2]?curTd.className="currMonth currDate":curTd.className="currMonth",curTr.appendChild(curTd)}if(6!==curMonthLastDay)for(var start=1;6-curMonthLastDay>=start;start++){var curTd=document.createElement("td");curTd.innerHTML=start,curTd.className="nextMonth",curTr.appendChild(curTd)}$(".select-date table tbody").append(curTr),$(".currMonth").on("click",function(e){void 0==that.startDate?that.startDate=[year,month,parseInt(e.target.innerHTML)]:isPeriodValidate(that.startDate,[year,month,parseInt(e.target.innerHTML)])?(that.endDate=that.startDate,that.startDate=[year,month,parseInt(e.target.innerHTML)]):alert("输入有误，请检查后重新设定！"),addPeriodDateInfo(year,month)}),$("#confirm").on("click",function(){if(that.startDate[0]>that.endDate[0]||that.startDate[0]==that.endDate[0]&&that.startDate[1]>that.endDate[1]||that.startDate[0]==that.endDate[0]&&that.startDate[1]==that.endDate[1]&&that.startDate[2]>that.endDate[2]){var temp=that.startDate;that.startDate=that.endDate,that.endDate=temp}$("#date-input").val(that.startDate[0]+"年"+that.startDate[1]+"月"+that.startDate[2]+"日 To "+that.endDate[0]+"年"+that.endDate[1]+"月"+that.endDate[2]+"日"),that.hideDOM(),that.isShow=0}),$("#cancel").on("click",function(){that.hideDOM(),that.isShow=0})}function isPeriodValidate(time1,time2){if(""==$("#maxPeriod").val()&&""==$("#minPeriod").val())return!0;var timeLength=getTimePeriodLength(time1,time2);return""==$("#maxPeriod").val()?timeLength>=parseInt($("#minPeriod").val()):""==$("#minPeriod").val()?timeLength<=parseInt($("#maxPeriod").val()):parseInt($("#maxPeriod").val())<parseInt($("#minPeriod").val())?!1:timeLength<=parseInt($("#maxPeriod").val())&&timeLength>=parseInt($("#minPeriod").val())}function getTimePeriodLength(time1,time2){var timeA=time1[0]+(time1[1]<10?"/0"+time1[1]:"/"+time1[1])+(time1[2]<10?"/0"+time1[2]:"/"+time1[2]),timeB=time2[0]+(time2[1]<10?"/0"+time2[1]:"/"+time2[1])+(time2[2]<10?"/0"+time2[2]:"/"+time2[2]),res=parseInt(new Date(timeA).getTime()-new Date(timeB).getTime())/864e5;return res>=0?res:-1*res}function getMonthDate(year,month){switch(0==month&&(year-=1,month=12),month){case 1:return 31;case 3:return 31;case 5:return 31;case 7:return 31;case 8:return 31;case 10:return 31;case 12:return 31;case 4:return 30;case 6:return 30;case 9:return 30;case 11:return 30;case 2:return year%4!=0?28:year%100==0&&year%400!=0?28:29}}var that=this;this.isShow=0,this.getCurrentTime=function(){return curTime()},this.setTime=function(data){data.split("-")[0],data.split("-")[1],data.split("-")[2];document.getElementById("date-input").value=currYear+""+currMonth+currDate,that.hideDOM()},this.initDOM=function(){0==type?$(selector).append('<div class="calendarTitle"><select id="month"></select><select id="year"></select></div><div class="select-date"><table><thead></thead><tbody></tbody></table></div>'):$(selector).append('<div class="period">最小跨度(默认无限制, 单位天)<input class="period-input" id="minPeriod">最大跨度(默认无限制，单位天)<input class="period-input" id="maxPeriod"></div><div class="calendarTitle"><select id="month"></select><select id="year"></select></div><div class="select-date"><table><thead></thead><tbody></tbody></table></div><div class="buttons"><button id="confirm">确认</button><button id="cancel">取消</button></div>');for(var i=-1*lowerYear;upperYear>=i;i++){var curOption=document.createElement("option");curOption.value=curTime()[0]+i+"年",curOption.innerHTML=curTime()[0]+i+"年",0==i&&(curOption.selected="selected"),$("#year").append(curOption)}for(var i=1;12>=i;i++){var curOption=document.createElement("option");curOption.value=i+"月",curOption.innerHTML=i+"月",i==curTime()[1]&&(curOption.selected="selected"),$("#month").append(curOption)}$("#month").on("change",function(e){var curMonth=parseInt(this.selectedOptions[0].value.split("月")[0]),curYear=parseInt(document.getElementById("year").selectedOptions[0].value.split("年")[0]);0==type?addCommonDateInfo(curYear,curMonth):addPeriodDateInfo(curYear,curMonth)}),$("#year").on("change",function(e){var curYear=parseInt(this.selectedOptions[0].value.split("年")[0]),curMonth=parseInt(document.getElementById("month").selectedOptions[0].value.split("月")[0]);0==type?addCommonDateInfo(curYear,curMonth):addPeriodDateInfo(curYear,curMonth)});var titleArr=["Su","Mo","Tu","We","Th","Fr","Sa"],curTr=document.createElement("tr");for(var i in titleArr){var cur=document.createElement("th");cur.innerHTML=titleArr[i],curTr.appendChild(cur)}$(".select-date table thead").append(curTr),0==type?addCommonDateInfo(curTime()[0],curTime()[1]):addPeriodDateInfo(curTime()[0],curTime()[1])},this.hideDOM=function(){$(".calendarTitle,.select-date").remove(),1==type&&$(".buttons,.period").remove()}}angular.module("questionnaireApp",["ui.router"]).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("app",{url:"/",views:{header:{templateUrl:"views/header.html"},content:{templateUrl:"views/home.html",controller:"IndexController"},footer:{templateUrl:"views/footer.html"}}}).state("app.data",{url:"data/:id",views:{"content@":{templateUrl:"views/data.html",controller:"DataController"}}}).state("app.view",{url:"view/:id",views:{"content@":{templateUrl:"views/view.html",controller:"ViewController"}}}).state("app.edit",{url:"edit/:id",views:{"content@":{templateUrl:"views/edit.html",controller:"EditController"}}}),$urlRouterProvider.otherwise("/")}),angular.module("questionnaireApp").filter("trust2Html",["$sce",function($sce){return function(val){return $sce.trustAsHtml(val)}}]).controller("EditController",["$scope","$stateParams","formFactory","feedbackFactory",function($scope,$stateParams,formFactory,feedbackFactory){$scope.isNew=!1,$scope.forms=formFactory.getForms(),$scope.form={_id:$scope.forms.length,name:"输入你的标题",status:"offboard",date:"",questions:[]},$scope.init=function(){$scope.cal=new calendar("#input-div",20,20,0),""==$stateParams.id?$scope.isNew=!0:$scope.form=formFactory.getIdForm(parseInt($stateParams.id,10)),"offboard"!=$scope.form.status&&($scope.modalShow=!0)},$scope.addOneSelect=function(){10==$scope.form.questions.length?alert("不能超过十个问题！"):$scope.form.questions.push({type:1,title:"单选题",chose:["选项1","选项2","选项3","选项4"],isSortable:!0})},$scope.addMutiSelect=function(){10==$scope.form.questions.length?alert("不能超过十个问题！"):$scope.form.questions.push({type:2,title:"多选题",chose:["选项1","选项2","选项3","选项4"],isSortable:!0})},$scope.addTextSelect=function(){10==$scope.form.questions.length?alert("不能超过十个问题！"):$scope.form.questions.push({type:3,title:"文本题",isMustAnswer:!1,isSortable:!1})},$scope.moveUpQuestion=function(obj){var index=$scope.form.questions.indexOf(obj);if(0==index)alert("该问题已是第一个问题，不能上移！");else{var temp=$scope.form.questions[index-1];$scope.form.questions[index-1]=$scope.form.questions[index],$scope.form.questions[index]=temp}},$scope.moveDownQuestion=function(obj){var index=$scope.form.questions.indexOf(obj);if(index==$scope.form.questions.length-1)alert("该问题已是最后一个问题，不能下移！");else{var temp=$scope.form.questions[index+1];$scope.form.questions[index+1]=$scope.form.questions[index],$scope.form.questions[index]=temp}},$scope.reuseQuestion=function(obj){if(10==$scope.form.questions.length)return void alert("不能超过十个问题！");var index=$scope.form.questions.indexOf(obj),temp=JSON.parse(JSON.stringify(obj));$scope.form.questions.splice(index+1,0,temp)},$scope.deleteQuestion=function(obj){if(1==$scope.form.questions.length)return void alert("至少要有一个问题！");var index=$scope.form.questions.indexOf(obj);$scope.form.questions.splice(index,1)},$scope.changeTime=function(){var time1=(new Date).toISOString().split("T")[0],time2=(new Date).toISOString().split("T")[1].split(".")[0];$scope.form.date=time1+" "+time2},$scope.showCalendar=function(){$scope.cal.isShow?($scope.cal.hideDOM(),$scope.cal.isShow=0):($scope.cal.isShow=1,$scope.cal.initDOM())},$scope.addChose=function(obj,id){for(var i in $scope.form.questions)if($scope.form.questions[i]==obj&&i==id){var newChose="新选项";$scope.form.questions[i].chose.push(newChose);break}},$scope.delChose=function(obj,id){for(var i in $scope.form.questions)if($scope.form.questions[i]==obj){$scope.form.questions[i].chose.splice(id,1);break}},$scope.uploadForm=function(){return 0==$scope.form.questions.length?void alert("至少要有一个问题！"):($scope.changeTime(),formFactory.uploadForm($scope.form),void alert("保存问卷成功！"))},$scope.postForm=function(){if($scope.endDate=$("#date-input").val(),""==$scope.endDate)return void alert("请选择截止日期！");if(0==$scope.form.questions.length)return void alert("至少要有一个问题！");var chose=$scope.endDate.split("-"),time=new Date;return parseInt(chose[0])<time.getFullYear()||parseInt(chose[0])==time.getFullYear()&&parseInt(chose[1])<time.getMonth()+1||parseInt(chose[0])==time.getFullYear()&&parseInt(chose[1])==time.getMonth()+1&&parseInt(chose[2])<time.getDate()?void alert("选择的截止时间不得早于当前时间！"):($scope.form.status="onboard",$scope.changeTime(),feedbackFactory.uploadMockData($scope.form),formFactory.uploadForm($scope.form),alert("发布问卷成功！"),void 0)}}]).controller("IndexController",["$scope","formFactory","feedbackFactory",function($scope,formFactory,feedbackFactory){$scope.forms=formFactory.getForms(),$scope.isShow=formFactory.getForms().length>0,$scope.modalShow=!1,$scope.deleteAllShow=!1,$scope.type=["onboard","offboard","ended"],$scope.statusHTML={onboard:"<p style='color: #40FF00'>发布中</p>",offboard:"<p>未发布</p>",ended:"<p style='color: red'>已结束</p>"},$scope.text={onboard:"查看数据",offboard:"查看问卷",ended:"查看数据"},$scope.jump={onboard:"data",offboard:"view",ended:"data"},$scope.init=function(){$scope.radio={};for(var i in $scope.forms)$scope.radio[$scope.forms[i]._id]=!1},$scope.selectAll=function(){$scope.isAll=!0;for(var i in $scope.forms)$scope.radio[$scope.forms[i]._id]=!0},$scope.clickDelete=function(e){"offboard"==formFactory.getIdForm(parseInt(e.target.id.split("-")[2])).status?($scope.modalShow=!0,$scope.deleteForm=formFactory.getIdForm(parseInt(e.target.id.split("-")[2]))):$scope.modal2Show=!0},$scope.hideModal=function(){$scope.modalShow=!1},$scope.hideModal2=function(){$scope.modal2Show=!1},$scope.hideDeleteAll=function(){$scope.deleteAllShow=!1},$scope.deleteAllCheck=function(){for(var i=0;i<$scope.forms.length;i++)"offboard"==$scope.forms[i].status&&(formFactory.deleteSpecificForm($scope.forms[i]),feedbackFactory.deleteSpecificFeedback($scope.forms[i]._id));$scope.deleteAllShow=!1},$scope.deleteCheck=function(){formFactory.deleteSpecificForm($scope.deleteForm),feedbackFactory.deleteSpecificFeedback($scope.deleteForm._id),$scope.hideModal()}}]).controller("DataController",["$scope","$stateParams","formFactory","feedbackFactory",function($scope,$stateParams,formFactory,feedbackFactory){$scope.form=formFactory.getIdForm(parseInt($stateParams.id,10)),$scope.feedback=feedbackFactory.getIdFeedback(parseInt($stateParams.id,10)),$scope.init=function(){for(var i=0;i<$scope.form.questions.length;i++)3==$scope.form.questions[i].type?$scope.form.questions[i].useful=$scope.feedback.feedback[i].useful:$scope.form.questions[i].portion=$scope.feedback.feedback[i].portion},$scope.getPie=function(obj,id){if(2==obj.type){for(var data1=[],i=0;i<obj.chose.length;i++)data1.push({value:obj.portion[i],name:obj.chose[i]});var option={tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{orient:"vertical",x:"left",data:obj.chose},calculable:!0,series:[{name:"统计结果",type:"pie",radius:[80,120],itemStyle:{normal:{label:{show:!0},labelLine:{show:!1}},emphasis:{label:{show:!0,position:"center",textStyle:{fontSize:"30",fontWeight:"bold"}}}},data:data1}]};require(["echarts","echarts/chart/pie"],function(ec){var myChart1=ec.init(document.getElementById("pie"+$scope.form.questions.indexOf(obj)));myChart1.setOption(option)})}}}]).controller("ViewController",["$scope","$stateParams","formFactory",function($scope,$stateParams,formFactory){$scope.form=formFactory.getIdForm(parseInt($stateParams.id,10))}]),angular.module("questionnaireApp").service("formFactory",function(){if(localStorage.getItem("forms"))var Forms=JSON.parse(localStorage.getItem("forms"));else{var Forms=[{_id:0,name:"问卷调查1",status:"onboard",date:"2016-04-12 17:57:28",questions:[{type:1,title:"问题1",chose:["选项1","选项2","选项3","选项4"],isSortable:!0},{type:2,title:"问题2",chose:["选项1","选项2","选项3","选项4"],isSortable:!0},{type:3,title:"问题3",isMustAnswer:!0,isSortable:!1},{type:1,title:"问题4",chose:["选项1","选项2"],isSortable:!0},{type:2,title:"问题5",chose:["选项1","选项2","选项3"],isSortable:!0}]},{_id:1,name:"问卷调查2",status:"offboard",date:"2016-04-10 17:57:28",questions:[{type:1,title:"问题1",chose:["选项1","选项2","选项3","选项4"],isSortable:!0},{type:2,title:"问题2",chose:["选项1","选项2","选项3","选项4"],isSortable:!0},{type:3,title:"问题3",isMustAnswer:!0,isSortable:!1},{type:1,title:"问题4",chose:["选项1","选项2"],isSortable:!0},{type:2,title:"问题5",chose:["选项1","选项2","选项3"],isSortable:!0}]},{_id:2,name:"问卷调查3",status:"ended",date:"2016-03-12 17:57:28",questions:[{type:1,title:"问题1",chose:["选项1","选项2","选项3","选项4"],isSortable:!0},{type:2,title:"问题2",chose:["选项1","选项2","选项3","选项4"],isSortable:!0},{type:3,title:"问题3",isMustAnswer:!0,isSortable:!1},{type:1,title:"问题4",chose:["选项1","选项2"],isSortable:!0},{type:2,title:"问题5",chose:["选项1","选项2","选项3"],isSortable:!0}]}];localStorage.setItem("forms",JSON.stringify(Forms))}this.getForms=function(){return Forms},this.getSpecificForm=function(type){for(var res=[],i=0;i<Forms.length;i++)Forms[i].status==type&&res.push(Forms[i]);return res},this.getIdForm=function(id){for(var i=0;i<Forms.length;i++)if(Forms[i]._id==id)return Forms[i]},this.deleteSpecificForm=function(obj){for(var i=0;i<Forms.length;i++)if(Forms[i]===obj){Forms.splice(i,1);break}localStorage.setItem("forms",JSON.stringify(Forms))},this.uploadForm=function(obj){for(var isFind=!1,i=0;i<Forms.length;i++)if(Forms[i]._id===obj._id){Forms[i]=obj,isFind=!0;break}isFind||Forms.push(obj),localStorage.setItem("forms",JSON.stringify(Forms))}}).service("feedbackFactory",function(){if(localStorage.getItem("feedbacks"))var Feedbacks=JSON.parse(localStorage.getItem("feedbacks"));else{var Feedbacks=[{_id:0,feedback:[{type:1,portion:[.34,.26,.3,.1]},{type:2,portion:[.14,.6,.06,.2]},{type:3,useful:.66},{type:1,portion:[.62,.38]},{type:2,portion:[.24,.56,.2]}]},{_id:1,feedback:[{type:1,portion:[.27,.33,.1,.3]},{type:2,portion:[.24,.5,.2,.06]},{type:3,useful:.36},{type:1,portion:[.75,.25]},{type:2,portion:[.14,.6,.26]}]},{_id:2,feedback:[{type:1,portion:[.1,.32,.26,.32]},{type:2,portion:[.2,.5,.06,.24]},{type:3,useful:.8},{type:1,portion:[.3,.7]},{type:2,portion:[.26,.6,.14]}]}];localStorage.setItem("feedbacks",JSON.stringify(Feedbacks))}this.getFeedbacks=function(id){return Feedbacks},this.getIdFeedback=function(id){for(var i=0;i<Feedbacks.length;i++)if(Feedbacks[i]._id==id)return Feedbacks[i]},this.deleteSpecificFeedback=function(id){for(var i=0;i<Feedbacks.length;i++)if(Feedbacks[i]._id===id){Feedbacks.splice(i,1);break}localStorage.setItem("feedbacks",JSON.stringify(Feedbacks))},this.uploadMockData=function(obj){var mock={};mock._id=obj._id,mock.feedback=[];for(var i=0;i<obj.questions.length;i++)switch(obj.questions[i].type){case 1:for(var data1=[],sum=0,j=0;j<obj.questions[i].chose.length-1;j++){var cur=parseFloat((.3*Math.random()).toFixed(2));sum+=parseFloat(cur),data1.push(cur)}data1.push(1-sum),mock.feedback.push({type:1,portion:data1});break;case 2:for(var data1=[],j=0;j<obj.questions[i].chose.length;j++)data1.push(parseFloat(Math.random().toFixed(2)));mock.feedback.push({type:2,portion:data1});break;case 3:var cur=parseFloat(Math.random().toFixed(2));mock.feedback.push({type:3,useful:cur})}Feedbacks.push(mock),localStorage.setItem("feedbacks",JSON.stringify(Feedbacks))}});